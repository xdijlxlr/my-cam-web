<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BoxCam - 訂單存證上傳</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-slate-950 text-white min-h-screen flex flex-col items-center p-6">

    <header class="mb-8 text-center">
        <h1 class="text-3xl font-bold text-blue-400"><i class="fas fa-box-open mr-2"></i>BoxCam 存證系統</h1>
    </header>

    <div class="w-full max-w-md bg-slate-900 rounded-3xl p-8 shadow-2xl border border-slate-800">
        
        <div class="mb-6">
            <label class="block text-sm font-medium text-gray-400 mb-2">訂單編號</label>
            <input type="text" id="orderId" placeholder="請輸入或貼上單號" 
                   class="w-full bg-slate-800 border border-slate-700 rounded-xl px-4 py-3 focus:outline-none focus:border-blue-500 transition">
        </div>

        <label class="cursor-pointer group block mb-6">
            <div id="dropzone" class="border-2 border-dashed border-slate-700 group-hover:border-blue-500 rounded-2xl p-8 text-center transition">
                <i class="fas fa-camera text-4xl text-slate-600 group-hover:text-blue-500 mb-3"></i>
                <p class="text-md font-medium">點擊拍照存證</p>
                <input type="file" id="fileInput" accept="image/*" capture="environment" class="hidden">
            </div>
        </label>

        <div id="previewContainer" class="hidden">
            <img id="imagePreview" class="w-full h-40 object-cover rounded-xl mb-4 border border-slate-700">
            <div id="statusText" class="text-sm text-center mb-4"></div>
            <button id="uploadBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 rounded-xl transition flex justify-center items-center">
                確認上傳紀錄
            </button>
        </div>
    </div>

    <script>
        // --- GitHub Actions 會自動替換這些值 ---
        const BASEROW_TOKEN = '{{BASEROW_TOKEN}}';
        const TABLE_ID = '{{BASEROW_TABLE_ID}}';
        
        // --- 請根據你的 Baserow 欄位代號修改 ---
        const FIELD_ORDER_ID = 'orderID'; // 訂單編號欄位
        const FIELD_PHOTO = 'photo';    // 照片檔案欄位
        const FIELD_TIME = 'time';     // 時間欄位 (若使用 Created on 類型則可忽略此欄)
        // ------------------------------------

        const fileInput = document.getElementById('fileInput');
        const previewContainer = document.getElementById('previewContainer');
        const imagePreview = document.getElementById('imagePreview');
        const uploadBtn = document.getElementById('uploadBtn');
        const statusText = document.getElementById('statusText');
        const orderIdInput = document.getElementById('orderId');

        let selectedFile = null;

        fileInput.addEventListener('change', (e) => {
            selectedFile = e.target.files[0];
            if (selectedFile) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    imagePreview.src = event.target.result;
                    previewContainer.classList.remove('hidden');
                    statusText.innerText = "檔案已就緒";
                    statusText.className = "text-sm text-center mb-4 text-blue-400";
                };
                reader.readAsDataURL(selectedFile);
            }
        });

        uploadBtn.addEventListener('click', async () => {
            if (!selectedFile) return alert('請先拍照！');
            
            const orderId = orderIdInput.value.trim();
            if (!orderId) return alert('請輸入訂單編號！');

            uploadBtn.disabled = true;
            uploadBtn.innerText = "上傳中...";
            statusText.innerText = "正在傳送至 Baserow...";

            try {
                // 1. 上傳檔案
                const formData = new FormData();
                formData.append('file', selectedFile);

                const fileResponse = await fetch('https://api.baserow.io/api/user-files/upload-file/', {
                    method: 'POST',
                    headers: { 'Authorization': `Token ${BASEROW_TOKEN}` },
                    body: formData
                });
                const fileData = await fileResponse.json();

                if (!fileResponse.ok) throw new Error('檔案上傳失敗');

                // 2. 準備 Row 資料 (包含單號與目前時間)
                const now = new Date().toISOString(); // 取得 ISO 格式時間
                const rowData = {};
                rowData[FIELD_ORDER_ID] = orderId;
                rowData[FIELD_PHOTO] = [{ "name": fileData.name }];
                rowData[FIELD_TIME] = now; 

                // 3. 寫入資料表
                const tableResponse = await fetch(`https://api.baserow.io/api/database/rows/table/${TABLE_ID}/?user_field_names=true`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Token ${BASEROW_TOKEN}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(rowData)
                });

                if (tableResponse.ok) {
                    statusText.innerText = "✅ 儲存成功！";
                    statusText.classList.replace('text-blue-400', 'text-green-400');
                    uploadBtn.innerText = "完成";
                    // 清除欄位
                    orderIdInput.value = "";
                } else {
                    throw new Error('資料寫入失敗');
                }
            } catch (error) {
                statusText.innerText = "❌ 錯誤：" + error.message;
                statusText.classList.replace('text-blue-400', 'text-red-400');
                uploadBtn.disabled = false;
                uploadBtn.innerText = "重試";
            }
        });
    </script>
</body>
</html>